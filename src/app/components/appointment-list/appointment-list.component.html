<div class="page-container">
  <header class="page-header">
    <h1>{{ title() }}</h1>
    <p *ngIf="listType === 'upcoming'">Gestiona tus prÃ³ximas visitas mÃ©dicas.</p>
    <p *ngIf="listType === 'past'">Consulta tu historial y recetas mÃ©dicas.</p>
  </header>

  <div class="appointment-grid">
    <ng-container *ngIf="appointments().length > 0; else noAppointments">
      
      <div *ngFor="let apt of appointments()" class="ticket-card fade-in" [ngClass]="apt.status">
        
        <div class="ticket-content">
          <div class="date-column">
            <span class="day">{{ apt.appointment_time | date:'d' }}</span>
            <span class="month">{{ apt.appointment_time | date:'MMM':'':'es-PE' | uppercase }}</span>
            <div class="time-pill">
              {{ apt.appointment_time | date:'h:mm a':'':'es-PE' }}
            </div>
          </div>

          <div class="info-column">
            
            <ng-container *ngIf="userRole() === 'patient'">
              <div class="person-header">
                <div class="avatar-circle">
                  {{ getInitials(apt.doctor?.full_name) }}
                </div>
                <div>
                  <h3>Dr. {{ apt.doctor?.full_name }}</h3>
                  <p class="subtitle">{{ apt.doctor?.specialties?.name }}</p>
                </div>
              </div>
              <div class="patient-subinfo">
                <small>Paciente: {{ apt.patient?.full_name || 'TÃº' }}</small>
              </div>
            </ng-container>

            <ng-container *ngIf="userRole() === 'doctor'">
              <div class="person-header">
                <div class="avatar-circle patient-color">
                  {{ getInitials(apt.patient?.full_name) }}
                </div>
                <div>
                  <h3>{{ apt.patient?.full_name }}</h3>
                  <p class="subtitle">Paciente</p>
                </div>
              </div>
            </ng-container>

            <div *ngIf="apt.rating" class="mini-rating">
              <span class="star">â˜…</span> <span>{{ apt.rating }} / 5</span>
            </div>
          </div>

          <div class="status-column">
            <span class="status-badge" [ngClass]="apt.status">
              {{ statusLabels[apt.status] || apt.status }}
            </span>

            <div class="actions-row" *ngIf="listType === 'upcoming'">
              <button *ngIf="userRole() === 'doctor'" class="btn-icon check" title="Completar" (click)="completeAppointment(apt.id)">
                âœ“
              </button>
              <button class="btn-icon trash" title="Cancelar" (click)="cancelAppointment(apt.id)">
                âœ•
              </button>
            </div>

            <div class="actions-row" *ngIf="listType === 'past'">
              <button class="btn-text" (click)="openEditor(apt.id)">
                {{ (apt.diagnosis || apt.rating) ? 'Ver Detalles' : 'Detalles' }}
              </button>
            </div>
          </div>
        </div>

        <div class="expandable-drawer" *ngIf="editingAppointmentId() === apt.id">
          
          <ng-container *ngIf="userRole() === 'doctor'">
            <div class="drawer-section">
              <label>DiagnÃ³stico MÃ©dico</label>
              <div *ngIf="apt.diagnosis" class="read-only-box">{{ apt.diagnosis }}</div>
              
              <div *ngIf="!apt.diagnosis" class="input-group">
                <textarea #diagnosis placeholder="Escribe el diagnÃ³stico clÃ­nico..."></textarea>
                <button class="save-btn" (click)="submitDiagnosis(apt.id, diagnosis)">Guardar DiagnÃ³stico</button>
              </div>
            </div>

            <div class="drawer-actions">
              <button *ngIf="!apt.prescriptions?.length" class="action-chip blue" (click)="createPrescription(apt)">
                + Crear Receta
              </button>
              <button *ngIf="apt.prescriptions?.length" class="action-chip green" (click)="prescriptionService.view(apt.prescriptions![0]!.id)">
                Ver Receta
              </button>
            </div>
          </ng-container>

          <ng-container *ngIf="userRole() === 'patient'">
            <div class="drawer-section" *ngIf="apt.diagnosis">
              <label>DiagnÃ³stico del Doctor</label>
              <div class="read-only-box">{{ apt.diagnosis }}</div>
            </div>

            <div class="drawer-actions" *ngIf="apt.prescriptions?.length">
              <button class="action-chip green full-width" (click)="appointmentService.exportPrescriptionPdf(apt.id)">
                ðŸ“„ Descargar Receta MÃ©dica (PDF)
              </button>
            </div>

            <div class="drawer-section rating-section">
              <label>Tu Experiencia</label>
              <div *ngIf="apt.rating" class="read-only-rating">
                <span *ngFor="let s of [1,2,3,4,5]" [class.filled]="s <= apt.rating">â˜…</span>
                <p>"{{ apt.feedback }}"</p>
              </div>

              <div *ngIf="!apt.rating" class="rating-input-container">
                <div class="stars-select">
                  <button *ngFor="let s of [1,2,3,4,5]" (click)="currentRating.set(s)" [class.active]="s <= (currentRating() || 0)">â˜…</button>
                </div>
                <textarea #feedback placeholder="Â¿CÃ³mo fue tu atenciÃ³n? (Opcional)"></textarea>
                <button class="save-btn" *ngIf="currentRating()" (click)="submitRating(apt.id, currentRating()!, feedback)">Enviar CalificaciÃ³n</button>
              </div>
            </div>
          </ng-container>

          <div class="drawer-footer">
            <button class="close-link" (click)="closeEditor()">Cerrar panel</button>
          </div>
        </div>

      </div>
    </ng-container>

    <ng-template #noAppointments>
      <div class="empty-state">
        <div class="empty-icon">ðŸ“…</div>
        <h3>No hay citas {{ listType === 'upcoming' ? 'programadas' : 'en el historial' }}</h3>
        <p>Tus citas aparecerÃ¡n aquÃ­.</p>
      </div>
    </ng-template>
  </div>
</div>