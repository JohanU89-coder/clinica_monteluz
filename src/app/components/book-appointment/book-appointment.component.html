<div class="page-container">
  <header class="page-header">
    <h1>Agendar una Nueva Cita</h1>
    <p>Sigue los pasos para encontrar un horario conveniente.</p>
  </header>

  <div *ngIf="bookingService.bookingStatus() === 'success'" class="alert success">
    ¡Cita agendada con éxito! Puedes verla en la pestaña "Próximas Citas".
  </div>
  <div *ngIf="bookingService.bookingStatus() === 'error'" class="alert error">
    Hubo un error al agendar tu cita. Por favor, inténtalo de nuevo.
  </div>

  <section class="booking-flow">
    
    <div class="step" *ngIf="authService.bookableProfiles().length > 1">
      <h3>0. ¿Para quién es la cita?</h3>
      <select [ngModel]="bookingService.forPatientId()" (ngModelChange)="bookingService.forPatientId.set($event)">
        <option [ngValue]="null" disabled>Selecciona un miembro de la familia...</option>
  
        <option *ngFor="let profile of authService.bookableProfiles(); let i = index" [value]="profile.id">
      {{ profile.full_name }} {{ i === 0 ? '(Tú)' : '' }}
  </option>

</select>
    </div>

    <ng-container *ngIf="bookingService.forPatientId()">
      <div class="step">
        <h3>1. Selecciona una Especialidad</h3>
        <select [ngModel]="selectedSpecialtyId" (ngModelChange)="onSpecialtyChange($event)">
          <option [ngValue]="null" disabled>Elige una especialidad...</option>
          <option *ngFor="let spec of dataService.specialties()" [value]="spec.id">{{ spec.name }}</option>
        </select>
      </div>

      <div class="step" *ngIf="dataService.doctors().length > 0">
        <h3>2. Selecciona un Doctor</h3>
        <div class="doctor-list">
          <button *ngFor="let doctor of dataService.doctors()" class="doctor-card" [class.selected]="bookingService.selectedDoctorId() === doctor.id" (click)="selectDoctor(doctor)">
            <h4>{{ doctor.full_name }}</h4>
            <p>{{ doctor.specialties?.name }}</p>
          </button>
        </div>
      </div>

      <div class="step" *ngIf="bookingService.selectedDoctorId()">
        <h3>3. Selecciona un Horario Disponible para <strong>{{ selectedDoctor()?.full_name }}</strong></h3>
        
        <div class="day-selector" *ngIf="bookingService.availableDays().length > 0; else noSlots">
          <button *ngFor="let day of bookingService.availableDays()" 
                  class="day-button"
                  [class.selected]="bookingService.selectedDate() === day.toISOString().split('T')[0]"
                  (click)="selectDay(day)">
            <span class="day-name">{{ day | date:'EEE':'':'es-PE' }}</span>
            <span class="day-number">{{ day | date:'d' }}</span>
          </button>
        </div>
        
        <div *ngIf="bookingService.selectedDate()">
          <h4 class="time-header">Horas disponibles para el {{ bookingService.selectedDate() | date:'fullDate':'':'es-PE' }}</h4>
          <div class="slots-list">
            <button *ngFor="let slot of bookingService.filteredSlotsByDay()"
                    class="slot-button"
                    [class.selected]="bookingService.selectedSlot()?.value === slot.value"
                    (click)="selectSlot(slot)">
              {{ slot.display }}
            </button>
          </div>
        </div>

        <ng-template #noSlots>
          <p class="empty-state">Este doctor no tiene horarios disponibles en los próximos 14 días.</p>
        </ng-template>
      </div>
    </ng-container>

  </section>

  <section class="confirmation-section" *ngIf="bookingService.selectedSlot()">
    <h3>Confirma tu Cita</h3>
    <div class="confirmation-details">
      <p><strong>Doctor:</strong> {{ selectedDoctor()?.full_name }}</p>
      <p><strong>Especialidad:</strong> {{ selectedDoctor()?.specialties?.name }}</p>
      <p><strong>Fecha y Hora:</strong> {{ bookingService.selectedSlot()?.value | date:'full':'':'es-PE' }}</p>
    </div>
    <button class="confirm-btn" (click)="confirmBooking()" [disabled]="bookingService.bookingStatus() === 'loading'">
      {{ bookingService.bookingStatus() === 'loading' ? 'Agendando...' : 'Confirmar Cita' }}
    </button>
  </section>
</div>